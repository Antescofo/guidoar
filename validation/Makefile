#
# Makefile for testing the guidoar tools
#
# Checking the engine output
#   the principle is the following:
#   an image target generates image files using guido2image for a large set of gmn files
#   the validate target makes the comparison of files generated by different versions
#
# Checking memory leaks
#   requires valgrind
#

version	:= $(shell cat version.txt)
guidopath  ?= ../../guidolib
gmndir  := $(guidopath)/gmn-examples
tool	:= guidohead
arg		:= "[ a g f ]"
targ	:= "1/1"

IGNORE   ?= ignored-min.txt
gmninput := $(shell find $(gmndir) -name "*.gmn" | grep -v -F -f $(IGNORE))


CUTTOOLS   := guidobottom guidoevhead guidoevtail guidohead guidotail guidotop
CUTNTOOLS  := guidobottomn guidoevheadn guidoevtailn guidotopn 
CUTDTOOLS  := guidoheadt guidotailt 
TRNSTOOLS  := guidoapplypitch guidoapplyrythm guidomirror guidomultduration guidosetduration guidosetdurationd guidotranspose guidotransposei 
MISCTOOLS  := guido2midi guido2unrolled guidoduration 
UNTESTED   := guidoev2time guidotime2ev 

READOUT 	:= $(gmninput:$(guidopath)/%.gmn=$(version)/read/%.gmn)
DUROUT 		:= $(gmninput:$(guidopath)/%.gmn=$(version)/guidoduration/%.txt)
CUTOUT 		:= $(gmninput:$(guidopath)/%.gmn=$(version)/$(CUTTOOL)/%.gmn)
CUTNOUT 	:= $(gmninput:$(guidopath)/%.gmn=$(version)/$(CUTTOOLN)/%.gmn)
CUTTOUT 	:= $(gmninput:$(guidopath)/%.gmn=$(version)/$(CUTTOOLT)/%.gmn)
MIDIOUT 	:= $(gmninput:$(guidopath)/%.gmn=$(version)/midi/%.mid)

default : read

help:
	@echo "Makefile for testing the guidoar tools output. Available targets are:"
	@echo "  'read' (default): read input file and write from AR representation"
	@echo "  'duration'      : test guidoduration"
	@echo "  'cut'           : test cut operations $(CUTTOOLS)"
	@echo "  'cutn'          : test cut operations $(CUTNTOOLS)"
	@echo "  'cutt'          : test cut operations $(CUTDTOOLS)"
	@echo "  'all'           : call all the targets above"
	@echo "  'midi'          : test mdi conversion (guido2midi)"


#########################################################################
# targets
all:
	make read
	make duration
	make cut
	make cutn
	make cutt

read: 		$(READOUT)
duration: 	$(DUROUT)
midi: 		$(MIDIOUT)
cut:
	make guidobottom CUTTOOL=guidobottom 
	make guidoevhead CUTTOOL=guidoevhead IGNORE=ignored.txt
	make guidoevtail CUTTOOL=guidoevtail IGNORE=ignored.txt
	make guidotail CUTTOOL=guidotail IGNORE=ignored.txt
	make guidotop CUTTOOL=guidotop IGNORE=ignored.txt

$(CUTTOOL): $(CUTOUT)

cutn:
	make guidobottomn CUTTOOLN=guidobottomn 
	make guidoevheadn CUTTOOLN=guidoevheadn IGNORE=ignored.txt
	make guidoevtailn CUTTOOLN=guidoevtailn IGNORE=ignored.txt
	make guidotopn CUTTOOLN=guidotopn IGNORE=ignored.txt

$(CUTTOOLN): $(CUTNOUT)

cutt:
	make guidoheadt CUTTOOLT=guidoheadt IGNORE=ignored.txt
	make guidotailt CUTTOOLT=guidotailt IGNORE=ignored.txt

$(CUTTOOLT): $(CUTTOUT)

#########################################################################
test: 
	@echo $(gmninput)


#########################################################################
# tools to validate the output, based diff
validate: $(validgmn)
	@echo Validating $(tool) - version $(version) with $(VERSION)

#########################################################################
clean: 
	rm -f $(gmnout)

#########################################################################
# rules

#### read
$(version)/read/%.gmn: $(guidopath)/%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	guidoread $< > $@ || (rm $@; false)

#### duration
$(version)/guidoduration/%.txt: $(guidopath)/%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	guidoduration $< > $@ || (rm $@; false)

#### cut tools
$(version)/$(CUTTOOLN)/%.gmn: $(guidopath)/%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	$(CUTTOOLN) $< 1 > $@ || (rm $@; false)
	guido2svg $@ > $@.svg
	guido2svg $< > $@.src.svg

$(version)/$(CUTTOOLT)/%.gmn: $(guidopath)/%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	$(CUTTOOLT) $< $(targ) > $@ || (rm $@; false)
	guido2svg $@ > $@.svg
	guido2svg $< > $@.src.svg

$(version)/$(CUTTOOL)/%.gmn: $(guidopath)/%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	$(CUTTOOL) $< $(arg) > $@ || (rm $@; false)
	guido2svg $@ > $@.svg
	guido2svg $< > $@.src.svg

#### midi
$(version)/midi/%.mid: $(guidopath)/%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	guido2midi $< $@ || (rm $@; false)


