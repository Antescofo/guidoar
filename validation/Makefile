#
# Makefile for testing the guidoar tools
#
# Checking the engine output
#   the principle is the following:
#   an image target generates image files using guido2image for a large set of gmn files
#   the validate target makes the comparison of files generated by different versions
#
# Checking memory leaks
#   requires valgrind
#

version	:= $(shell guidoarversion)
system	:= $(shell uname -s)
tool	:= guidohead
arg		:= "[ a a a ]"

ifdef TOOL
	TOOLPATH := $(shell basename $(TOOL))
endif

gmnfiles     = $(shell find ../gmn -name "*.gmn")
gmnout		:= $(patsubst ../%.gmn, $(version)/$(tool)/%.gmn, $(gmnfiles))
allgmn 		 = $(shell [ -d $(version)/$(tool) ] && find $(version)/$(tool) -name "*.gmn")

checkgmn 	= $(patsubst %.gmn, %.checkgmn, $(allgmn))
durgmn 	 	= $(patsubst %.gmn, %.durgmn, $(allgmn))
validgmn 	= $(patsubst %.gmn, %.outgmn, $(allgmn))


default : cut

test:
	echo tool: $(tool)

help:
	@echo "Makefile for testing the guidoar tools output. Available targets are:"
	@echo "'cut' (default): test cut operations (head tail, evhead, evtail..."

#########################################################################
# tools to check the output correctness
check: $(checkgmn)

checkdur: $(durgmn)

%.checkgmn: %.gmn
	guidocheck $<	

%.durgmn: %.gmn
	guidoduration $<

#########################################################################
# tools to validate the output, based diff
validate: $(validgmn)
	@$(eval tmp := $(shell [ -f $(version)/ignore.$(VERSION).txt ] && echo "using $(version)/ignore.$(VERSION).txt"))	
	@echo Validating version $(version) with $(VERSION) $(tmp)
	
%.outgmn: %.gmn
	$(eval tmp := $(patsubst $(version)/$(tool)/%, $(VERSION)/%, $<))	
	@[ -f  $(tmp) ] || echo $< : new file
	$(eval ignored := $(shell grep $< $(version)/ignore.$(VERSION).txt 2>/dev/null || echo _none_))
	@[ -f  $(ignored) ] || (diff $< $(tmp) 2>/dev/null >/dev/null || [ -f  $(tmp) ] && echo "open $< $(patsubst $(version)/%, $(VERSION)/%, $<) # to check changes"; true)

#########################################################################
clean: 
	rm -f $(gmnout)

#########################################################################
# tools to generate svg files
cut: $(gmnout)

$(version)/$(tool)/%.gmn: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	-$(tool) $< $(arg) > $@

